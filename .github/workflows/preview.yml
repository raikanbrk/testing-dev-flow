name: Ephemeral Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository && github.event.action != 'closed'
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: devc4rlos/testing-dev-flow
          tags: |
            type=raw,value=pr-${{ github.event.pull_request.number }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: php
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            br.com.carlosalexandre.preview.pr=${{ github.event.pull_request.number }}
            br.com.carlosalexandre.preview.general=true
          build-args: |
            COMPOSER_CACHE_KEY=${{ hashFiles('composer.lock') }}
            NPM_CACHE_KEY=${{ hashFiles('package-lock.json') }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy_preview:
    needs: build_and_push
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository && github.event.action != 'closed'
    environment:
      name: Preview
    permissions:
      pull-requests: write
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            trap 'echo "--- docker compose ps ---"; docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} ps || true; echo "--- docker compose logs (last 200 lines) ---"; docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} logs --no-color --tail=200 || true' ERR

            PR_NUMBER=${{ github.event.pull_request.number }}
            IMAGE_TAG=${{ needs.build_and_push.outputs.image_tag }}
            PROJECT_DIR="/var/www/previews-prs/testing-dev-flow/pr-${PR_NUMBER}"

            export HOSTNAME="testing-dev-flow-pr-${PR_NUMBER}.preview.carlosalexandre.com.br"
            export ROUTER_NAME="testing-dev-flow-pr-${PR_NUMBER}"
            export SERVICE_NAME="testing-dev-flow-pr-${PR_NUMBER}"
            export IMAGE_TAG

            if [ ! -d "$PROJECT_DIR/.git" ]; then
              git clone git@github.com:${{ github.repository }}.git ${PROJECT_DIR}
              cd ${PROJECT_DIR}

              git fetch origin
              git checkout ${{ github.event.pull_request.head.sha }}

              cp .env.preview .env

              sed -i "s#^APP_URL=.*#APP_URL=https://${HOSTNAME}#" .env || echo "APP_URL=https://${HOSTNAME}" >> .env

              KEY=$(openssl rand -base64 32 | sed 's/^/base64:/')
              sed -i "s#^APP_KEY=.*#APP_KEY=${KEY}#" .env

              ln -s ~/.htpasswd ./docker/nginx/.htpasswd || true
            else
              cd ${PROJECT_DIR}
              docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} down -v
            fi

            git fetch origin
            git checkout ${{ github.event.pull_request.head.sha }}

            docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} up -d --pull=always

            echo "Aguardando o banco de dados ficar pronto..."
            TIMEOUT=60
            while ! docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} exec -T mysql mysqladmin ping --silent; do
              sleep 1
              TIMEOUT=$((TIMEOUT-1))
              if [ $TIMEOUT -le 0 ]; then
                echo "Erro: O banco de dados não ficou pronto a tempo."
                exit 1
              fi
            done
            echo "Banco de dados pronto!"

            echo "Aguardando health do app (FPM)..."
            APP_TIMEOUT=120
            until [ "$(docker inspect --format='{{json .State.Health.Status}}' "$(docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} ps -q app)" 2>/dev/null | tr -d '"')" = "healthy" ]; do
              sleep 2
              APP_TIMEOUT=$((APP_TIMEOUT-2))
              if [ $APP_TIMEOUT -le 0 ]; then
                echo "Erro: app não ficou saudável a tempo."
                exit 1
              fi
            done
            echo "App saudável."

            echo "Executando migrações..."
            if ! docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} exec -T app php artisan migrate --force; then
              echo "Migrações falharam, tentando novamente em 5s..."
              sleep 5
              docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} exec -T app php artisan migrate --force
            fi
            echo "Migrações concluídas."

            echo "Verificando readiness HTTP de https://${HOSTNAME} ..."
            READY_TIMEOUT=120
            while true; do
              HTTP_CODE=$(curl -k -sS -o /dev/null -w "%{http_code}" --max-time 5 "https://${HOSTNAME}/")
              case "$HTTP_CODE" in
                200|301|302|401)
                  echo "Readiness OK (${HTTP_CODE}) em ${HOSTNAME}."
                  break
                  ;;
                *)
                  sleep 2
                  READY_TIMEOUT=$((READY_TIMEOUT-2))
                  if [ $READY_TIMEOUT -le 0 ]; then
                    echo "Erro: readiness HTTP não atingido. Último código: ${HTTP_CODE}"
                    exit 1
                  fi
                  ;;
              esac
            done

      - name: Post Preview URL to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ github.event.pull_request.number }}
          header: preview-url
          message: |
            ✅ **Preview pronto!**
            Acesse em: https://testing-dev-flow-pr-${{ github.event.pull_request.number }}.preview.carlosalexandre.com.br

            > Imagem: `devc4rlos/testing-dev-flow:${{ needs.build_and_push.outputs.image_tag }}`

  destroy_preview:
    if: github.event.action == 'closed' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    environment:
      name: Preview
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Destroy Environment on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            PR_NUMBER=${{ github.event.pull_request.number }}
            SERVICE_NAME="testing-dev-flow-pr-${PR_NUMBER}"
            PROJECT_DIR="/var/www/previews-prs/testing-dev-flow/pr-${PR_NUMBER}"

            if [ -d "$PROJECT_DIR" ]; then
              cd ${PROJECT_DIR}

              echo "--- Estado antes da remoção ---"
              docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} ps -a || true

              echo "--- Logs finais (últimos 200) ---"
              docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} logs --no-color --tail=200 || true

              echo "Derrubando stack e removendo volumes..."
              docker compose -f docker-compose.preview.yml -p ${SERVICE_NAME} down -v || true

              echo "Removendo diretório do projeto..."
              cd ..
              rm -rf ${PROJECT_DIR}
            fi

            echo "Removendo imagens com label da PR no servidor..."
            IMAGES_TO_DELETE=$(docker images -q --filter "label=br.com.carlosalexandre.preview.pr=${PR_NUMBER}")
            if [ -n "$IMAGES_TO_DELETE" ]; then
              docker rmi $IMAGES_TO_DELETE || true
            else
              echo "Nenhuma imagem com a label da PR encontrada."
            fi

            echo "Limpando imagens dangling e cache local..."
            docker image prune -f || true
            docker builder prune -f || true

            echo "Removendo networks do projeto..."
            for NET in $(docker network ls --format '{{.Name}}' | grep "^${SERVICE_NAME}"); do
              if [ "$NET" != "proxy" ]; then
                docker network rm "$NET" || true
              fi
            done

      - name: Install and Login to regctl
        run: |
          curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 -o /usr/local/bin/regctl
          chmod +x /usr/local/bin/regctl
          regctl registry login docker.io -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"

      - name: Delete PR-prefixed tag from Docker Hub
        run: |
          REPO="docker.io/devc4rlos/testing-dev-flow"
          PR_TAG="pr-${{ github.event.pull_request.number }}"
          echo "Removendo tag da PR: ${PR_TAG}"
          regctl tag rm "${REPO}:${PR_TAG}" || echo "Tag ${PR_TAG} não encontrada."
